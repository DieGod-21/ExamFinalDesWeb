<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Autenticación - Examen Final</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../views/css/styles.css">
</head>
<body>
    <div class="login-container">
        <div class="card">
            <div id="loginView">
                <div class="card-header">
                    <div class="logo-circle">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h1>Examen Final</h1>
                    <p>Serie I: Sistema de Autenticación</p>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-user me-2"></i>Usuario
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-user"></i>
                            </span>
                            <input type="text" class="form-control" id="username" placeholder="Ej: dvasquezs4">
                        </div>
                        <div class="helper-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Solo la parte antes de @miumg.edu.gt
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-lock me-2"></i>Contraseña
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-lock"></i>
                            </span>
                            <input type="password" class="form-control" id="password" placeholder="Ingrese su contraseña">
                            <span class="input-group-text eye-icon" onclick="togglePassword()">
                                <i class="fas fa-eye" id="eyeIcon"></i>
                            </span>
                        </div>
                    </div>

                    <div id="errorAlert" class="alert alert-danger d-none" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="errorMessage"></span>
                    </div>

                    <button class="btn btn-login" id="loginBtn" onclick="handleLogin()">
                        <i class="fas fa-sign-in-alt me-2"></i>
                        <span id="btnText">Iniciar Sesión</span>
                    </button>

                    <div class="password-hint">
                        <i class="fas fa-key me-2"></i>
                        Contraseña de prueba: <strong>123456a</strong>
                    </div>
                </div>
            </div>

            <div id="successView" class="d-none">
                <div class="card-body success-container">
                    <div class="success-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <h2 class="mb-2">¡Autenticación Exitosa!</h2>
                    <p class="text-muted mb-3">Serie I completada correctamente</p>
                    <span class="badge-success">
                        <i class="fas fa-check-circle me-1"></i>
                        Token almacenado en sessionStorage
                    </span>

                    <div class="info-box mt-4">
                        <div class="row mb-2">
                            <div class="col-5 info-label">Usuario:</div>
                            <div class="col-7 info-value text-end" id="displayUsername"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 info-label">Hora de login:</div>
                            <div class="col-7 info-value text-end" id="displayTime"></div>
                        </div>
                        <div class="row">
                            <div class="col-12 info-label mb-2">Token (primeros 50 caracteres):</div>
                            <div class="col-12">
                                <div class="token-box" id="displayToken"></div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Listo para Serie II</strong><br>
                        <small>El token está guardado y disponible para las siguientes pruebas</small>
                    </div>

                    <button class="btn btn-logout" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt me-2"></i>
                        Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const token = sessionStorage.getItem('authToken');
            if (token) {
                showSuccessView();
            }
        });

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        }

        async function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorAlert = document.getElementById('errorAlert');
            const loginBtn = document.getElementById('loginBtn');
            const btnText = document.getElementById('btnText');

            errorAlert.classList.add('d-none');

            if (!username || !password) {
                showError('Por favor complete todos los campos');
                return;
            }

            loginBtn.disabled = true;
            btnText.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Autenticando...';

            try {
                const response = await fetch('https://backcvbgtmdesa.azurewebsites.net/api/login/authenticate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        Username: username,
                        Password: password
                    })
                });

                const data = await response.json();

                if (response.ok && data.token) {
                    sessionStorage.setItem('authToken', data.token);
                    sessionStorage.setItem('username', username);
                    sessionStorage.setItem('loginTime', new Date().toISOString());
                    
                    console.log('Login exitoso. Token guardado');
                    console.log('Token:', data.token.substring(0, 30) + '...');
                    
                    showSuccessView();
                } else {
                    showError(data.message || 'Credenciales incorrectas. Verifique usuario y contrasena.');
                }
            } catch (error) {
                console.error('Error en login:', error);
                showError('Error de conexion. Verifique su conexion a internet e intente nuevamente.');
            } finally {
                loginBtn.disabled = false;
                btnText.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesion';
            }
        }

        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorAlert.classList.remove('d-none');
        }

        function showSuccessView() {
            const username = sessionStorage.getItem('username');
            const loginTime = new Date(sessionStorage.getItem('loginTime'));
            const token = sessionStorage.getItem('authToken');

            const timeString = loginTime.toLocaleString('es-GT', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            document.getElementById('displayUsername').textContent = username;
            document.getElementById('displayTime').textContent = timeString;
            document.getElementById('displayToken').textContent = token.substring(0, 50) + '...';

            document.getElementById('loginView').classList.add('d-none');
            document.getElementById('successView').classList.remove('d-none');
        }

        function handleLogout() {
            sessionStorage.removeItem('authToken');
            sessionStorage.removeItem('username');
            sessionStorage.removeItem('loginTime');

            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('errorAlert').classList.add('d-none');

            document.getElementById('successView').classList.add('d-none');
            document.getElementById('loginView').classList.remove('d-none');

            console.log('Sesion cerrada correctamente');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            document.getElementById('username').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
        });
    </script>
</body>
</html>